# Refactor Opportunities - 2026-01-09

## High Priority

### 1. Stringly-typed enums
Many status fields are `String` but have known values.

| File | Field | Values |
|------|-------|--------|
| `models/checkout.rs:11` | `Checkout.status` | PENDING, FAILED, PAID |
| `models/checkout.rs:56` | `purpose` | CHECKOUT, SETUP_RECURRING_PAYMENT |
| `models/checkout.rs:86` | `payment_type` | card, boleto, ideal, etc. |
| `models/payout.rs:10` | `Payout.status` | PENDING, PROCESSING, COMPLETED, FAILED |
| `models/reader.rs:8` | `Reader.status` | ACTIVE, INACTIVE, LOST, STOLEN |
| `models/reader.rs:59` | `ReaderCheckoutResponse.status` | PENDING, COMPLETED, FAILED, CANCELLED |

**Fix:** Create enums with `#[serde(rename_all = "SCREAMING_SNAKE_CASE")]`

```rust
#[derive(Debug, Clone, Copy, Serialize, Deserialize, PartialEq, Eq)]
#[serde(rename_all = "SCREAMING_SNAKE_CASE")]
pub enum CheckoutStatus {
    Pending,
    Failed,
    Paid,
}
```

### 2. OAuth error handling duplication
`src/oauth.rs` has 3x repeated error handling blocks (lines 111-129, 149-167, 189-207).

**Fix:** Add helper method or reuse pattern from `SumUpClient::handle_response`

### 3. Currency as String
`currency: String` appears everywhere. Should be an enum or newtype.

**Fix:**
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Currency(pub String);
// or enum for known currencies: EUR, GBP, USD, etc.
```

### 4. Amount as f64
Money amounts use `f64` which has precision issues.

**Fix:** Use `rust_decimal::Decimal` or integer cents with a wrapper type.

```rust
pub struct Amount {
    pub cents: i64,
    pub currency: Currency,
}
```

## Medium Priority

### 5. Builder pattern for requests
`CreateCheckoutRequest` has many optional fields - awkward to construct.

**Fix:**
```rust
CreateCheckoutRequest::builder()
    .checkout_reference("order-123")
    .amount(9.99)
    .currency("EUR")
    .merchant_code("MC123")
    .description("Coffee")
    .build()
```

### 6. Transaction timestamp as String
`models/transaction.rs:17` - `timestamp: String` should be `DateTime<Utc>`.

### 7. Missing `Default` derives
Some request types lack `Default`, making construction verbose.

| Type | File |
|------|------|
| `CreateCheckoutRequest` | models/checkout.rs |
| `ProcessCheckoutRequest` | models/checkout.rs |
| `CreateOperatorRequest` | subaccounts.rs |

### 8. Inconsistent list response wrappers
Some endpoints return arrays directly, others wrap in objects:

| Response | Wrapper |
|----------|---------|
| `list_checkouts` | `Vec<Checkout>` (direct) |
| `list_memberships` | `MembershipListResponse { items }` |
| `list_merchant_payouts` | `PayoutListResponse { payouts }` |
| `list_merchant_readers` | `ReaderListResponse { readers }` |

**Fix:** Standardize - either always wrap or handle at API layer.

### 9. No retry/backoff logic
Network errors and rate limits aren't retried.

**Fix:** Add optional retry middleware or `tower` integration.

### 10. No tracing/logging
Hard to debug API calls.

**Fix:** Add `tracing` spans to API methods.

## Low Priority

### 11. Unused `EmptyObject` type
`models/common.rs` defines `EmptyObject` - only used in `DeletedCheckout.transactions`.

**Fix:** Remove or replace with `Vec<()>` or `serde_json::Value`.

### 12. `birth_date` as String
`models/customer.rs:23` - `birth_date: Option<String>` should be `chrono::NaiveDate`.

### 13. OAuthClient doesn't share http_client
Creates its own `reqwest::Client` instead of sharing with `SumUpClient`.

**Fix:** Accept `Client` in constructor or use `Arc<Client>`.

### 14. No integration test for OAuth
Only unit tests exist for core API methods.

### 15. Webhook event types incomplete
`webhooks.rs` defines few event types - may need more based on actual API.

### 16. Query structs could use generics
`PayoutListQuery`, `ReceiptRetrieveQuery`, etc. have repetitive pagination fields.

**Fix:**
```rust
pub struct Paginated<T> {
    pub query: T,
    pub limit: Option<i32>,
    pub offset: Option<i32>,
}
```

## Won't Fix (By Design)

- `use_sandbox` parameter ignored - SumUp uses same URL, key determines environment
- Deprecated `/me/` endpoints removed - API doesn't support them

## Suggested Order

1. Status enums (high impact, low risk)
2. Builder patterns (ergonomics)
3. OAuth dedup (cleanup)
4. Decimal amounts (if handling real money)
5. Tracing (debugging)
6. Retry logic (reliability)
